@page "/"
@using ChibiCSharp
@using System.Net
@rendermode InteractiveServer

<PageTitle>Home</PageTitle>

<div>
    <h4>ChibiC# - C#によるC#コンパイラ</h4>
    <div class="code">
        <h5>コード</h5>
        <div>
            <button @onclick="OnClickSample">サンプルコード</button> @Explanation (@(Count == -1 ? "-" : Count + 1) / @SampleCode.Length)
        </div>
        <textarea @bind=@Code @oninput="OnInputChange" placeholder="ココにコードを書くかサンプルコードを押してください" style="width: 300px; height: 150px;"></textarea>
    </div>
    <p>↓</p>
    <div class="compile">
        <h5>アセンブリ</h5>
        <pre class="border">
            @(Assembly)
        </pre>
    </div>
    <div class="run">
        <button @onclick="OnClickRun">ilasm.exe → 実行(ExitCodeを表示)</button>
        <div class="border">
            @(ExeResult)
        </div>
    </div>
    <div>
        <br/>
        <blockquote>inspired by <a href="https://www.sigbus.info/compilerbook">低レイヤを知りたい人のためのCコンパイラ作成入門</a></blockquote>
        <ul>
            <li>ステップ13: ブロック</li>
            <li><s>ステップ12: 制御構文を足す</s></li>
            <li><s>ステップ11：return文</s></li>
            <li><s>ステップ10：複数文字のローカル変数</s></li>
            <li><s>ステップ9：1文字のローカル変数</s></li>
            <li><s>ステップ8: ファイル分割とMakefileの変更</s></li>
            <li><s>ステップ7: 比較演算子</s></li>
            <li><s>ステップ6：単項プラスと単項マイナス</s></li>
            <li><s>ステップ5：四則演算のできる言語の作成</s></li>
            <li><s>ステップ4：エラーメッセージを改良</s></li>
            <li><s>ステップ3：トークナイザを導入</s></li>
            <li><s>ステップ2：加減算のできるコンパイラの作成</s></li>
            <li><s>ステップ1：整数1個をコンパイルする言語の作成</s></li>
        </ul>
    </div>
</div>


@code {
    private string Code { get; set; } = "";
    private string Assembly = "";
    private string ExeResult = "";
    private string Explanation = "";

    private static readonly (string,string)[] SampleCode =
    {
        ("計算式", $"return (3+5)/2;"),
        ("比較演算子", $"return 0<=1;"),
        ("変数代入", $"a=3;{Environment.NewLine}z=5;{Environment.NewLine}return a+z;"),
        ("if文", $"if (1) return 2;{Environment.NewLine}return 3;"),
        ("while文", $"i=0;{Environment.NewLine}while(i<10) i=i+1;{Environment.NewLine}return i;"),
        ("for文", $"i=0;{Environment.NewLine}j=0;{Environment.NewLine}for (i=0; i<=10; i=i+1) j=i+j;{Environment.NewLine}return j;"),
    };
    private static int Count = -1;

    private void OnInputChange(ChangeEventArgs e)
    {
        Code = e.Value?.ToString() ?? "";
        Assembly = WebUtility.HtmlEncode(Compiler.Compile(Code));
    }

    private void OnClickSample()
    {
        Count = (Count + 1) % SampleCode.Length;
        Explanation = SampleCode[Count].Item1;
        Code = SampleCode[Count].Item2;
        Assembly = WebUtility.HtmlEncode(Compiler.Compile(Code));
    }

    private void OnClickRun()
    {
        ExeResult = Executer.Run(Assembly);
    }
}